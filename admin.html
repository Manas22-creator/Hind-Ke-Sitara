<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/admin.css">
</head>

<body>

    <div id="login-container" class="admin-container">
        <h2>Admin Login</h2>
        <form id="admin-login-form">
            <input type="text" id="admin-username" placeholder="Admin Username" required>
            <input type="password" id="admin-password" placeholder="Admin Password" required>
            <button type="submit">Login</button>
        </form>
        <p id="error-message" style="color: red;"></p>
    </div>

    <div id="dashboard-container" class="admin-container" style="display: none;">
        <h2>Admin Dashboard</h2>
        <button onclick="logout()">Logout</button>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="user-table">
                <!-- Users will be loaded here -->
            </tbody>
        </table>

        <div class="song-requests">
            <h2>Requested Songs</h2>
            <ul id="song-requests-list"></ul>
        </div>
    </div>

    <script>
        const ADMIN_USERNAME = "admin";
        const ADMIN_PASSWORD = "admin123";

        document.getElementById("admin-login-form").addEventListener("submit", function (event) {
            event.preventDefault();

            const username = document.getElementById("admin-username").value;
            const password = document.getElementById("admin-password").value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                localStorage.setItem("adminLoggedIn", "true");
                showDashboard();
            } else {
                document.getElementById("error-message").innerText = "Invalid username or password!";
            }
        });

        function showDashboard() {
            document.getElementById("login-container").style.display = "none";
            document.getElementById("dashboard-container").style.display = "block";
            loadUsers();
        }




        // Update to load hashed passwords
        async function loadUsers() {
            const response = await fetch("http://localhost:5000/api/users");
            const users = await response.json();

            const tableBody = document.getElementById("user-table");
            tableBody.innerHTML = "";


            for (let i = 0; i < localStorage.length; i++) {
                let username = localStorage.key(i);
                if (username === "adminLoggedIn" || username === "songRequests") continue; // Skip admin session & song requests


                // let userData = JSON.parse(localStorage.getItem(username));

                // Check if userData is valid
                users.forEach(user => {
                    let row = `<tr>
      <td>${user.username}</td>
     <td>••••••••</td> <!-- Masked password -->
      <td><button onclick="deleteUser('${user.username}')">Delete</button></td>
    </tr>`;
                    tableBody.innerHTML += row;
                });
            }

        }


        async function deleteUser(username) {
            if (confirm(`Are you sure you want to delete ${username}?`)) {
                await fetch(`http://localhost:5000/api/users/${username}`, {
                    method: "DELETE"
                });
                loadUsers();
            }
        }

        function logout() {
            localStorage.removeItem("adminLoggedIn");
            location.reload(); // Refresh to show login screen
        }

        // Auto-login check
        if (localStorage.getItem("adminLoggedIn") === "true") {
            showDashboard();
        }
    </script>

    <script src="js/admin.js"></script>

</body>

</html>